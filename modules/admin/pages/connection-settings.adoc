:m4dreg:

= Настройка {of-mir}

Администратору необходимо с помощью данной инструкции выполнить настройку системы {dv} для использования {of-mir}.

[#mancons]
== Настройки подключения в {of-mc}

. После установки _{of-mir}_ в _{sett-serv}_ _{of-mc}_ автоматически появляется специальный тип конфигурации _Коннектор к реестру МЧД_.
. В {of-mc} откройте вкладку "Служба {ws}" и подключите новый процесс. Подробнее см. "xref:dev@mgmtconsole:user:worker-service.adoc[]".
+
[WARNING]
====
Чтобы статус передачи доверенности в {cr} изменялся корректно, убедитесь, что учетная запись _Службы {ws}_ обладает правами на изменение карточки доверенности во всех состояниях.

Чтобы обеспечить необходимые права, для вида МЧД в конструкторе состояний выдайте доступ к операции _Запись_. Затем в конструкторе ролей для этого же вида предоставьте права на операцию _Запись_ в состоянии _Отозвана_ для роли _СистемнаяWF_.
====
// .Вкладка "Служба {ws}"
// image::worker-tab.png[Вкладка "Служба {ws}"]
+
. Нажмите на кнопку *Подключить процесс*
. В появившемся окне введите _Имя процесса_ и выберите _Тип конфигурации_ *_Коннектор к реестру МЧД_*.
. В выпадающем меню выберите _Сервис по работе с МЧД_. От выбранного сервиса зависит количество обязательных для заполнения полей. +
Сервис обязателен для заполнения.
+
. Укажите настройки сервиса по работе с МЧД:
+
.Настройки процесса в {of-mc} для сервиса {kd}
image::settings.png[Настройки процесса в {of-mc} для сервиса {kd}]
+
.Для {kd}:
****
* В поле _Точка подключения_ укажите адрес подключения к сервису {kd}. +
Поле обязательно для заполнения.
+
--
include::ROOT:requirements.adoc[tags=url-kd]
--
****
+
.Настройки процесса в {of-mc} для сервиса СБИС
image::sbis.png[Настройки процесса в {of-mc} для сервиса СБИС]
+
.Для СБИС:
****
include::ROOT:requirements.adoc[tags=url-sbis]
+
include::5.5.5@edi:sbis:connection-settings.adoc[tags=params]
****
+
. Укажите остальные настройки процесса:
+
.Прочие настройки процесса:
****
* _Интервал запросов_ -- значение в секундах, в соответствии с которым будут происходить обращения в сервис {kd}. По умолчанию интервал равен `15`. Рекомендуемый интервал `15` сек. +
Поле обязательно для заполнения.
+
* Соединение {dv} -- поле обязательно для заполнения, подробнее см. в разделе "xref:dev@mgmtconsole:user:worker-service.adoc#add[Добавить процесс]" документации модуля {mc}.
* Таймаут -- поле необязательно для заполнения, подробнее см. в разделе "xref:dev@mgmtconsole:user:worker-service.adoc#add[Добавить процесс]" документации модуля {mc}.
* Использовать x86 -- установите флаг, чтобы переключить обработку заданий на версию {of-ws} с указанной разрядностью. Когда флаг снят, используется разрядность x64.
****
+
NOTE: В {of-mc}, в разделах Очередь "xref:dev@mgmtconsole:user:msg-incoming.adoc[входящих]" и "xref:dev@mgmtconsole:user:msg-outgoing.adoc[исходящих]" сообщений отображаются все действия с МЧД. Если в процессе выполнения запроса возникла ошибка, она будет отображена в {of-mc}, на странице "xref:dev@mgmtconsole:user:msg-outgoing.adoc[Очередь исходящих сообщений]".

[#config-services]
== Настройки конфигурации сервисов

После установки модуля в {of-mc} вместо названия _Сервиса обработки_ и _Типа сообщений_ отображается идентификатор. Чтобы вместо идентификаторов отображались локализованные названия, необходимо в конфигурационном файле по адресу `C:\Program Files (x86)\Docsvision\ManagementConsoleExternalAPI\DocsVision.ManagementConsole.ExternalAPI.WindowsService.exe.config` добавить следующие строки:

[source,html]
----
<WorkerFactories>
    <Libraries>
      <add Path="DocsVision.BackOffice.ObjectModel, Version=5.5.0.0, Culture=neutral, PublicKeyToken=7148afe997f90519" />
      <add Path="DocsVision.M4dRegistry.WorkerService, Version=5.5.0.0, Culture=neutral, PublicKeyToken=7148afe997f90519" />
    </Libraries>
  </WorkerFactories>
----

[#register]
== Настройки регистрации МЧД

.Чтобы иметь возможность регистрировать МЧД в {cr}, выполните следующие действия:
. Создайте вид карточки для работы с МЧД. Для {wc}а можно воспользоваться готовым примером. Для этого нужно импортировать вид карточки документа ПКД menu:PowersOfAttorney[Data > SolutionOfPOA.sol] из примера "xref:dev@webclient:programmer:other/powers-of-attorney.adoc[]".
. В разметку просмотра МЧД (версия 002) добавьте ЭУ `_Кнопка_`, например, *Зарегистрировать МЧД*, и добавьте скрипт `sendForRegistrationToRegistry` для события `*При щелчке*`.
+
На регистрацию передаётся xml-файл МЧД и файл подписи. После регистрации формируется СКД, статус которой будет проверен автоматически. Результат проверки будет записан в карточку с указанием даты проверки.

[#check]
== Настройки проверки МЧД

.Чтобы иметь возможность проверять статус МЧД в {cr}, полученной от контрагента:
. Создайте вид карточки для работы с МЧД. Для {wc}а можно воспользоваться готовым примером. Для этого нужно импортировать вид карточки документа ПКД menu:PowersOfAttorney[Data > SolutionOfPOA.sol] из примера "xref:dev@webclient:programmer:other/powers-of-attorney.adoc[]".
. В разметку просмотра МЧД (версия 002) добавьте ЭУ `_Кнопка_`, например, *Проверить МЧД*, и добавьте скрипт `checkPowerOfAttorney` для события `*При щелчке*`.
+
Необходимая для проверки информация будет получена из карточки xref:system:ROOT:terms.adoc#attorney[СКД]. Для проверки МЧД в {cr} потребуется передавать её номер и ИНН организации.

[#recall]
== Настройки отзыва МЧД

.Чтобы иметь возможность отозвать МЧД, зарегистрированную в {cr}, выполните следующие действия:
. Создайте вид карточки для работы с МЧД. Для {wc}а можно воспользоваться готовым примером. Для этого нужно импортировать вид карточки документа ПКД menu:PowersOfAttorney[Data > SolutionOfPOA.sol] из примера "xref:dev@webclient:programmer:other/powers-of-attorney.adoc[]".
. В разметку просмотра МЧД (версия 002) добавьте ЭУ `_Кнопка_`, например, *Отозвать МЧД*, и добавьте скрипт `recallPowerOfAttorney` для события `*При щелчке*`.

